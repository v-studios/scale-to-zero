version: 1.0
runtime: python3                # has python, pip, setuptools, wheel, virtualenv

build:
  commands:
    # It looks like `cd` commands are stickey, each command is NOT in a subshell, so return back up
    pre-build:
      # On this runtime it seems SQLite is too old... how old??
      # 08-04-2022 06:56:10 PM sqlite3.NotSupportedError: deterministic=True requires SQLite 3.8.3 or higher
      # I'm seeing it saying SQLITE NOT FOUND but then never doing apt stuff
      # - sqlite --version || echo SQLITE NOT FOUND
      # I tried `&&` on the update and install and the build failed silently
      # Even with EPEL, yum installs Sqlite 3.7
      # Gawd, build from source gives 3.38.5 2022-05-06 15:25:27
      - echo "THIS IS PRE-BUILD"
    build:
      - echo "THIS IS BUILD"
      - echo "PATH=$PATH"
      - echo "PATH_HACKED=$PATH_HACKED"
      - curl https://www.sqlite.org/2022/sqlite-autoconf-3380500.tar.gz | tar xzvf -
      - cd sqlite-autoconf-3380500 && ./configure && make && make install && cd .. && rm -r sqlite-autoconf-3380500 && rm sqlite-autoconf-3380500.tar.gz
      - sqlite3 --version
      - /usr/local/bin/sqlite3 --version
      - which sqlite3 || echo "NO WHICH SQLITE3"
      - python -m venv /VENV
      - /VENV/bin/pip install wagtail
      - wagtail start site2
      - /VENV/bin/pip install -r site2/requirements.txt
      - echo "CURRENT DIR:"
      - pwd && ls -al
      - echo "SITE2 DIR:"
      - ls -al site2
      - echo "ABOUT TO MIGRATE..."
      - site2/manage.py migrate
      - DJANGO_SUPERUSER_PASSWORD=KILLME site2/manage.py createsuperuser --noinput --username chris2 --email chris@v-studios.com
    post-build:
      - echo "THIS IS POST-BUILD"
  env:                        # is this read by the build, so we get /usr/local/sqlite3 instead of /usr/bin?
    - name: PATH_HACKED
      value: "/usr/local/bin:${PATH}"

run:
  command: site2/manage.py runserver
  env:
    - name: PATH_RUN
      value: "/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
  network:
    port: 8000                  # wagtail default
    env: APP_PORT
  runtime-version: 3.8
